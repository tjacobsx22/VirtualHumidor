<!DOCTYPE html>
<html lang="en" ng-app="myApp">
<head>

    <script type="text/javascript" src="/VirtualHumidor/scripts/jquery.js"></script>
    <script type="text/javascript" src="/VirtualHumidor/scripts/angular.js"></script>
    <script type="text/javascript" src="/VirtualHumidor/bootstrap/js/bootstrap.js"></script>
    <script type="text/javascript" src="/VirtualHumidor/jquery-ui-1.10.3.custom/js/jquery-ui-1.10.3.custom.js"></script>
    <script type="text/javascript" src="/VirtualHumidor/js/kendo.web.js"></script>
    <script type="text/javascript" src="/VirtualHumidor/select2-3.4.3/select2.js"></script>
    <script type="text/javascript" src="/VirtualHumidor/js/select2-ui.js"></script>
    <link href="/VirtualHumidor/bootstrap/css/bootstrap.css" rel="stylesheet">
    <link href="/VirtualHumidor/select2-3.4.3/select2.css" rel="stylesheet">
    <link href="/VirtualHumidor/bootstrap/css/bootstrap-responsive.css" rel="stylesheet">
    <link href="/VirtualHumidor/styles/kendo.common.min.css" rel="stylesheet" media="screen">
    <link href="/VirtualHumidor/styles/kendo.default.min.css" rel="stylesheet" media="screen">
    <link href="/VirtualHumidor/jquery-ui-1.10.3.custom/css/flick/jquery-ui-1.10.3.custom.css" rel="stylesheet" media="screen">
    <title>Virtual Humidor</title>
    <style>
        .note{
            width: 100%
        }
    </style>
    <script type="text/javascript">
        var myAppModule = angular.module('myApp', ['ui.select2']);

        function Cigars($scope, $http) {
            //$scope.select2Options = {
            //    "page-limit": 10
            //};
            //$http.get('GetCigarDatabase.php').success(function(data){
            //    $scope.cigars = data;
            //});
        }

        $(document).ready(function() {
            $("#cigarPicker").select2({
                minimumInputLength: 3,
                ajax: { // instead of writing the function to execute the request we use Select2's convenient helper
                    url: "getCigarDropDown.php",
                    dataType: 'json',
                    data: function (term, page) {
                        return {
                            q: term
                        };
                    },
                    results: function (data, page) {
                        return {results: data};
                    }
                }
            });
            $("#humidor").kendoGrid({
                dataSource: {
                    type: "json",
                    transport: {
                        read: "/VirtualHumidor/GetCigars.php"
                    },
                    schema: {
                        model: {
                            fields: {
                                UserId: { type: "string" },
                                CigarId: { type: "string" },
                                CigarName: { type: "string" },
                                CigarBrand: { type: "string" },
                                CigarVitola: { type: "string" },
                                CigarQuantity: { type: "string" },
                                PurchaseDate: { type: "string" }
                            }
                        }
                    },
                    pageSize: 10,
                    serverPaging: true,
                    serverFiltering: true,
                    serverSorting: true
                },
                filterable: true,
                sortable: true,
                pageable: true,
                columns: [{
                    field:"CigarName"
                },
                    {
                        field:"CigarBrand"
                    },
                    {
                        field:"CigarVitola"
                    },
                    {
                        field:"CigarQuantity"
                    },
                    {
                        field:"PurchaseDate"
                    },
                    {
                        field: "Buttons",
                        title: "",
                        template: '<a href="javascript:void(0);" class="btn btn-small btn-primary" onclick="addNote(\'#= UserId #\', \'#= CigarId #\')"><i class="icon-edit icon-white"></i></a>'
                    }
                ]
            });
        });
        function addNote(id, cigarId){
            $("#addNotesModal").modal('show');
            $("#userId").val(id);
            $("#cigarId").val(cigarId);
            $("#notes").kendoGrid({
                dataSource: {
                    type: "json",
                    transport: {
                        read: "/VirtualHumidor/GetNotes.php?user=" + id + "&cigar=" + cigarId + ""
                    },
                    schema: {
                        model: {
                            fields: {
                                NoteId: { type: "string" },
                                Note: { type: "string" }
                            }
                        }
                    },
                    pageSize: 5,
                    serverPaging: true,
                    serverFiltering: true,
                    serverSorting: true
                },
                filterable: true,
                sortable: true,
                pageable: true,
                columns: [
                    {
                        field:"Note"
                    }
                ]
            });
        };
        function saveNote(){
            $.ajax({
                        url: 'SaveNote.php',
                        type: 'post',
                        data: {
                            id : $("#userId").val(),
                            cigarid: $("#cigarId").val(),
                            note : $("#note").val()
                        },
                        success: function() {
                            $("#note").val("");
                            $("#notes").data("kendoGrid").dataSource.read();
                        }
            });
        };
    </script>
</head>
<body>
<div ng-controller="Cigars">
    <div class="container">
        <div class="row">
            <div class="span12">
                <h1>Virtual Humidor</h1>
            </div>
        </div>
        <div class="row">
            <div class="span12">
                <input class="input-xlarge" type='hidden' ui-select2 id="cigarPicker" ng-model="selected"/>
                <br/>
                Selected:
                <br/>
                {{selected.name}} - {{selected.wrapper}} - {{selected.color}} - {{selected.strength}}
            </div>
        </div>
        <div class="row">
            <div class="span12">
                <div id="humidor"></div>
            </div>
        </div>
    </div>
    <!-- Modal -->
    <div id="addNotesModal" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">x</button>
            <h3 id="myModalLabel">Cigar Notes</h3>
        </div>
        <div class="modal-body">
            <div class="container-fluid">
                <div class="row-fluid">
                    <div class="span12">
                        <div id="notes"></div>
                        <textarea id="note" class="note" rows="10"></textarea>
                        <input id="userId" style="display:none"/>
                        <input id="cigarId" style="display:none"/>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn" data-dismiss="modal" aria-hidden="true">Close</button>
            <button class="btn btn-primary" onclick="saveNote()">Save note</button>
        </div>
    </div>
</div>
</body>
</html>